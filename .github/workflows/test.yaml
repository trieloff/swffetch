name: Swift Lint & Test

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: ["**"]

permissions:
  contents: write

jobs:
  test-macos:
    name: Test macOS (Swift ${{ matrix.swift }})
    runs-on: macos-latest
    strategy:
      matrix:
        swift: ["5.9"]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ matrix.swift }}

      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install SwiftLint and lcov
        run: |
          brew install swiftlint lcov

      - name: Lint (SwiftLint)
        run: swiftlint

      - name: Build
        run: swift build --build-tests -Xswiftc -warnings-as-errors

      - name: Run Tests with Coverage
        run: swift test --enable-test-discovery --enable-code-coverage -Xswiftc -warnings-as-errors

      - name: Generate coverage report
        run: |
          xcrun llvm-cov export .build/arm64-apple-macosx/debug/SwiftFFetchPackageTests.xctest/Contents/MacOS/SwiftFFetchPackageTests \
            -instr-profile=.build/arm64-apple-macosx/debug/codecov/default.profdata \
            -format="lcov" > coverage.lcov

      - name: Filter coverage to source files only
        run: |
          # Filter to only include our source files
          lcov --extract coverage.lcov "*/Sources/SwiftFFetch/*" -o coverage_filtered.lcov

      - name: Generate coverage summary
        run: |
          echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Source Files Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Line Coverage | Function Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------------|-------------------|" >> $GITHUB_STEP_SUMMARY

          xcrun llvm-cov report .build/arm64-apple-macosx/debug/SwiftFFetchPackageTests.xctest/Contents/MacOS/SwiftFFetchPackageTests \
            -instr-profile=.build/arm64-apple-macosx/debug/codecov/default.profdata \
            | grep "Sources/SwiftFFetch" \
            | while read -r line; do
              file=$(echo "$line" | awk '{print $1}' | sed 's/.*Sources\/SwiftFFetch\///')
              line_cov=$(echo "$line" | awk '{print $8}')
              func_cov=$(echo "$line" | awk '{print $11}')
              echo "| $file | $line_cov | $func_cov |" >> $GITHUB_STEP_SUMMARY
            done

      - name: Upload coverage to Codecov
        if: matrix.os == 'macos-latest'
        uses: codecov/codecov-action@v4
        with:
          file: coverage_filtered.lcov
          flags: unittests
          name: SwiftFFetch Coverage
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Coverage Gate
        run: |
          # Extract overall coverage percentage for source files
          COVERAGE=$(xcrun llvm-cov report .build/arm64-apple-macosx/debug/SwiftFFetchPackageTests.xctest/Contents/MacOS/SwiftFFetchPackageTests \
            -instr-profile=.build/arm64-apple-macosx/debug/codecov/default.profdata \
            | grep "Sources/SwiftFFetch" | awk '{sum+=$8*$7; total+=$7} END {printf "%.2f", sum/total}')

          echo "Overall source code coverage: $COVERAGE%"

          # Set minimum coverage threshold (80%)
          THRESHOLD=80.0

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi

  test-ios:
    name: Test iOS Simulator (Swift ${{ matrix.swift }})
    runs-on: macos-latest
    strategy:
      matrix:
        swift: ["5.9"]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ matrix.swift }}

      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-ios-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-ios-spm-

      - name: Build for iOS Simulator
        run: |
          swift build --build-tests -Xswiftc -sdk -Xswiftc $(xcrun --sdk iphonesimulator --show-sdk-path) -Xswiftc -target -Xswiftc x86_64-apple-ios15.0-simulator

      - name: Run Tests on iOS Simulator
        run: |
          swift test -Xswiftc -sdk -Xswiftc $(xcrun --sdk iphonesimulator --show-sdk-path) -Xswiftc -target -Xswiftc x86_64-apple-ios15.0-simulator

  test-tvos:
    name: Test tvOS Simulator (Swift ${{ matrix.swift }})
    runs-on: macos-latest
    strategy:
      matrix:
        swift: ["5.9"]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ matrix.swift }}

      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-tvos-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-tvos-spm-

      - name: Build for tvOS Simulator
        run: |
          swift build --build-tests -Xswiftc -sdk -Xswiftc $(xcrun --sdk appletvsimulator --show-sdk-path) -Xswiftc -target -Xswiftc x86_64-apple-tvos15.0-simulator

      - name: Run Tests on tvOS Simulator
        run: |
          swift test -Xswiftc -sdk -Xswiftc $(xcrun --sdk appletvsimulator --show-sdk-path) -Xswiftc -target -Xswiftc x86_64-apple-tvos15.0-simulator

  test-watchos:
    name: Test watchOS Simulator (Swift ${{ matrix.swift }})
    runs-on: macos-latest
    strategy:
      matrix:
        swift: ["5.9"]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ matrix.swift }}

      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-watchos-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-watchos-spm-

      - name: Build for watchOS Simulator
        run: |
          swift build --build-tests -Xswiftc -sdk -Xswiftc $(xcrun --sdk watchsimulator --show-sdk-path) -Xswiftc -target -Xswiftc x86_64-apple-watchos8.0-simulator

      - name: Run Tests on watchOS Simulator
        run: |
          swift test -Xswiftc -sdk -Xswiftc $(xcrun --sdk watchsimulator --show-sdk-path) -Xswiftc -target -Xswiftc x86_64-apple-watchos8.0-simulator

  update-badge:
    name: Update Vibe Coded Badge
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip vibe-badge]')"
    needs: [test-macos, test-ios, test-tvos, test-watchos]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: trieloff/vibe-coded-badge-action@main
